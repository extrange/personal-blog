<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://nicholaslyz.com/blog/2022/07/10/windows-gaming-vm-with-gpu-passthrough-on-linux/">
      
      
        <link rel="prev" href="../../../05/22/my-self-hosting-journey/">
      
      
        <link rel="next" href="../docker-containers-with-gpu-access-in-fedora/">
      
      
        
      
      
      <link rel="icon" href="../../../../../static/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Windows Gaming VM with GPU Passthrough on Linux - Nicholas</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/code.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/bookerly/font.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
<meta property="og:type" content="website">
<meta property="og:title" content="Windows Gaming VM with GPU Passthrough on Linux - Nicholas">
<meta property="og:image" content="https://nicholaslyz.com/assets/images/social/blog/2022/07/10/windows-gaming-vm-with-gpu-passthrough-on-linux.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://nicholaslyz.com/blog/2022/07/10/windows-gaming-vm-with-gpu-passthrough-on-linux/">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="Windows Gaming VM with GPU Passthrough on Linux - Nicholas">
<meta property="twitter:image" content="https://nicholaslyz.com/assets/images/social/blog/2022/07/10/windows-gaming-vm-with-gpu-passthrough-on-linux.png">
<link href="../../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="yellow">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#windows-gaming-vm-with-gpu-passthrough-on-linux" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Nicholas" class="md-header__button md-logo" aria-label="Nicholas" data-md-component="logo">
      
  <img src="../../../../../static/images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nicholas
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Windows Gaming VM with GPU Passthrough on Linux
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Nicholas" class="md-nav__button md-logo" aria-label="Nicholas" data-md-component="logo">
      
  <img src="../../../../../static/images/favicon.png" alt="logo">

    </a>
    Nicholas
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2">
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/books/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Books
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/cooking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cooking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/debates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/finance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Finance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/insurance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Insurance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/outdoor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Outdoor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/programming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Programming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Pinned
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pinned
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../dead-mans-switch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dead Man's Switch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2">
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Lifestyle
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Lifestyle
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../principles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Principles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../daily-routine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Daily Routine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../mountaineering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mountaineering
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../photography/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Photography
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../piano/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Piano
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../travel-bucket-list/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Travel Bucket List
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites:
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-gpu-passthrough" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. GPU Passthrough
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-setup-the-windows-vm" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Setup the Windows VM
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-optional-share-a-filesystem-between-host-and-guest" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. (Optional) Share a Filesystem between host and guest
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issuesnotesfixes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Known Issues/Notes/Fixes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Known Issues/Notes/Fixes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#slow-fps-on-desktop" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slow FPS on Desktop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amd-gpu-resetreboot-issue" class="md-nav__link">
    <span class="md-ellipsis">
      
        AMD GPU Reset/Reboot Issue
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-vfio" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disabling VFIO
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moonlight-specific-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Moonlight-specific Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qemuvirt-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        QEMU/virt-manager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apache-guacamole" class="md-nav__link">
    <span class="md-ellipsis">
      
        Apache Guacamole
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tailscale-latency-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tailscale latency issues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg>
                        <time datetime="2022-07-10 00:00:00+00:00" class="md-ellipsis">July 10, 2022</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/programming/">Programming</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg>
                          <span class="md-ellipsis">
                            
                              10 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




<h1 id="windows-gaming-vm-with-gpu-passthrough-on-linux">Windows Gaming VM with GPU Passthrough on Linux</h1>
<figure>
  <a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="/static/images/2022-07-10/demo.jpg" data-desc-position="bottom"><img src="/static/images/2022-07-10/demo.jpg" alt="Gaming on a laptop remotely over Nvidia Gamestream" loading="lazy"></a>
  <figcaption>Gaming on a laptop remotely with Nvidia Gamestream using mobile data</figcaption>
</figure>

<p>After completing this guide, you will have a Windows <strong>headless</strong> virtual machine that can be accessed via <a href="https://moonlight-stream.org/">Moonlight</a> for high performance gaming, with the <a href="https://app.lizardbyte.dev/Sunshine/?lng=en">Sunshine</a> game stream host.</p>
<!-- more -->

<h2 id="prerequisites">Prerequisites:</h2>
<ul>
<li>CPU with I/O virtualization support so we can passthrough PCIe devices (e.g. <a href="https://www.thomas-krenn.com/en/wiki/Overview_of_the_Intel_VT_Virtualization_Features"><code>VT-d</code></a> for Intel)</li>
<li>Any GPU</li>
</ul>
<p>The instructions in this guide are for NixOS, but I've also included Fedora-specific commands where relevant.</p>
<h2 id="1-gpu-passthrough">1. GPU Passthrough</h2>
<p>Ensure that I/O virtualization support has been enabled in your BIOS.</p>
<p>Follow <a href="https://wiki.nixos.org/wiki/PCI_passthrough">this guide</a> to enable IOMMU in the kernel, as well as the VFIO kernel modules.</p>
<details class="note">
<summary>For Fedora</summary>
<p>First, obtain the PCI vendor and device IDs of your GPU and its audio device (later referenced as <code>xxxx:xxxx</code> and <code>yyyy:yyyy</code> respectively):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>❯ lspci -nn | grep -i vga -A2
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>03:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Navi 48 [Radeon RX 9070/9070 XT/9070 GRE] [1002:7550] (rev c0)
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>03:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Navi 48 HDMI/DP Audio Controller [1002:ab40]
</span></code></pre></div>
<p>Append <code>intel_iommu=on vfio-pci.ids=xxxx:xxxx,yyyy:yyyy</code> to your <a href="https://wiki.archlinux.org/title/Kernel_parameters">kernel parameters</a>.</p>
<p><em>Note: if you are using an Nvidia GPU, it may be necessary to blacklist the Nouveau driver, by appending <code>rd.driver.blacklist=nouveau modprobe.blacklist=nouveau</code>.</em></p>
<p>Add the drivers to the initramfs:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># in /etc/dracut.conf.d/10-vfio.conf</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nv">add_drivers</span><span class="o">+=</span><span class="s2">" vfio_pci vfio vfio_iommu_type1 "</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># Then, rebuild the ramdisk</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>dracut<span class="w"> </span>-fv
</span></code></pre></div>
<p>Verify that the generated ramdisk contains the VFIO drivers:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a># lsinitrd | grep -i vfio
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>-rw-r--r--   1 root     root           31 Mar 30 16:53 etc/modprobe.d/vfio.conf
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>-rw-r--r--   1 root     root            9 Mar 30 16:53 etc/modules-load.d/vfio-pci.conf
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>drwxr-xr-x   1 root     root            0 Mar 30 16:53 usr/lib/modules/5.18.18-200.fc36.x86_64/kernel/drivers/vfio
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>&lt;truncated&gt;
</span></code></pre></div>
<p>Install libvirt:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>dnf<span class="w"> </span>install<span class="w"> </span>@virtualization
</span></code></pre></div>
</details>
<p>Reboot, and verify that IOMMU is working:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>$<span class="w">&nbsp;</span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>iommu
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Command<span class="w"> </span>line:<span class="w"> </span><span class="nv">BOOT_IMAGE</span><span class="o">=(</span>hd4,gpt4<span class="o">)</span>/vmlinuz-5.18.10-200.fc36.x86_64<span class="w"> </span><span class="nv">root</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>2a1d4d2a-7016-4f91-aa55-92d1b284668d<span class="w"> </span>ro<span class="w"> </span><span class="nv">rootflags</span><span class="o">=</span><span class="nv">subvol</span><span class="o">=</span>root<span class="w"> </span><span class="nv">resume</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>16671cec-3bb8-46bb-b931-083c93082763<span class="w"> </span>rhgb<span class="w"> </span>quiet<span class="w"> </span><span class="nv">intel_iommu</span><span class="o">=</span>on
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.133682<span class="o">]</span><span class="w"> </span>Kernel<span class="w"> </span><span class="nb">command</span><span class="w"> </span>line:<span class="w"> </span><span class="nv">BOOT_IMAGE</span><span class="o">=(</span>hd4,gpt4<span class="o">)</span>/vmlinuz-5.18.10-200.fc36.x86_64<span class="w"> </span><span class="nv">root</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>2a1d4d2a-7016-4f91-aa55-92d1b284668d<span class="w"> </span>ro<span class="w"> </span><span class="nv">rootflags</span><span class="o">=</span><span class="nv">subvol</span><span class="o">=</span>root<span class="w"> </span><span class="nv">resume</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>16671cec-3bb8-46bb-b931-083c93082763<span class="w"> </span>rhgb<span class="w"> </span>quiet<span class="w"> </span><span class="nv">intel_iommu</span><span class="o">=</span>on
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="hll"><span class="o">[</span><span class="w">    </span><span class="m">0</span>.133749<span class="o">]</span><span class="w"> </span>DMAR:<span class="w"> </span>IOMMU<span class="w"> </span>enabled
</span></span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.224446<span class="o">]</span><span class="w"> </span>DMAR-IR:<span class="w"> </span>IOAPIC<span class="w"> </span>id<span class="w"> </span><span class="m">2</span><span class="w"> </span>under<span class="w"> </span>DRHD<span class="w"> </span>base<span class="w">  </span>0xfed91000<span class="w"> </span>IOMMU<span class="w"> </span><span class="m">0</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.516533<span class="o">]</span><span class="w"> </span>iommu:<span class="w"> </span>Default<span class="w"> </span>domain<span class="w"> </span>type:<span class="w"> </span>Translated
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.516533<span class="o">]</span><span class="w"> </span>iommu:<span class="w"> </span>DMA<span class="w"> </span>domain<span class="w"> </span>TLB<span class="w"> </span>invalidation<span class="w"> </span>policy:<span class="w"> </span>lazy<span class="w"> </span>mode
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="hll"><span class="o">[</span><span class="w">    </span><span class="m">1</span>.560968<span class="o">]</span><span class="w"> </span>pci<span class="w"> </span><span class="m">0000</span>:00:00.0:<span class="w"> </span>Adding<span class="w"> </span>to<span class="w"> </span>iommu<span class="w"> </span>group<span class="w"> </span><span class="m">0</span>
</span></span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="hll"><span class="o">[</span><span class="w">    </span><span class="m">1</span>.560977<span class="o">]</span><span class="w"> </span>pci<span class="w"> </span><span class="m">0000</span>:00:01.0:<span class="w"> </span>Adding<span class="w"> </span>to<span class="w"> </span>iommu<span class="w"> </span>group<span class="w"> </span><span class="m">1</span>
</span></span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="hll"><span class="o">[</span><span class="w">    </span><span class="m">1</span>.560985<span class="o">]</span><span class="w"> </span>pci<span class="w"> </span><span class="m">0000</span>:00:06.0:<span class="w"> </span>Adding<span class="w"> </span>to<span class="w"> </span>iommu<span class="w"> </span>group<span class="w"> </span><span class="m">2</span>
</span></span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="hll"><span class="o">[</span><span class="w">    </span><span class="m">1</span>.560991<span class="o">]</span><span class="w"> </span>pci<span class="w"> </span><span class="m">0000</span>:00:0a.0:<span class="w"> </span>Adding<span class="w"> </span>to<span class="w"> </span>iommu<span class="w"> </span>group<span class="w"> </span><span class="m">3</span>
</span></span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="hll"><span class="o">[</span><span class="w">    </span><span class="m">1</span>.561003<span class="o">]</span><span class="w"> </span>pci<span class="w"> </span><span class="m">0000</span>:00:14.0:<span class="w"> </span>Adding<span class="w"> </span>to<span class="w"> </span>iommu<span class="w"> </span>group<span class="w"> </span><span class="m">4</span>
</span></span></code></pre></div>
<p>Verify that VFIO drivers have been loaded:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>❯<span class="w"> </span>lspci<span class="w"> </span>-knn<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span>-i<span class="w"> </span>vga
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="m">03</span>:00.0<span class="w"> </span>VGA<span class="w"> </span>compatible<span class="w"> </span>controller<span class="w"> </span><span class="o">[</span><span class="m">0300</span><span class="o">]</span>:<span class="w"> </span>Advanced<span class="w"> </span>Micro<span class="w"> </span>Devices,<span class="w"> </span>Inc.<span class="w"> </span><span class="o">[</span>AMD/ATI<span class="o">]</span><span class="w"> </span>Navi<span class="w"> </span><span class="m">48</span><span class="w"> </span><span class="o">[</span>Radeon<span class="w"> </span>RX<span class="w"> </span><span class="m">9070</span>/9070<span class="w"> </span>XT/9070<span class="w"> </span>GRE<span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="m">1002</span>:7550<span class="o">]</span><span class="w"> </span><span class="o">(</span>rev<span class="w"> </span>c0<span class="o">)</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">        </span>Subsystem:<span class="w"> </span>Tul<span class="w"> </span>Corporation<span class="w"> </span>/<span class="w"> </span>PowerColor<span class="w"> </span>Reaper<span class="w"> </span>Radeon<span class="w"> </span>RX<span class="w"> </span><span class="m">9070</span><span class="w"> </span>XT<span class="w"> </span>16GB<span class="w"> </span>GDDR6<span class="w"> </span><span class="o">(</span>RX9070XT<span class="w"> </span>16G-A<span class="o">)</span><span class="w"> </span><span class="o">[</span>148c:2435<span class="o">]</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="hll"><span class="w">        </span>Kernel<span class="w"> </span>driver<span class="w"> </span><span class="k">in</span><span class="w"> </span>use:<span class="w"> </span>vfio-pci
</span></span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">        </span>Kernel<span class="w"> </span>modules:<span class="w"> </span>amdgpu
</span></code></pre></div>
<h2 id="2-setup-the-windows-vm">2. Setup the Windows VM</h2>
<details class="note">
<summary>Boot and auxilliary drives</summary>
<p>The boot drive of the VM should be installed on an SSD. Having a COW filesystem (e.g. BtrFS) is a plus, since NTFS doesn't have checksumming. If a COW filesystem is used on the host, a raw image (not QCOW2) should be used to avoid COW-on-COW write amplification.</p>
<p>If a HDD is used, ZFS (with the zvol passed through) should be used for <a href="../../../../2025/06/07/btrfs-vs-zfs-performance/">maximum performance</a>. This zvol should be created as sparse (<code>-s</code> on <code>zfs create</code>) so snapshots can continue to be created using unallocated space from the pool. You can keep the zvol size ~200GB smaller than the HDD.</p>
<p>Redundancy via RAID can optionally be setup as well.</p>
<p><em>Note: Snapshotting is not done for the boot drive because it tends to bloat very quickly.</em></p>
</details>
<p>In order:</p>
<ul>
<li>Ensure that an emulated TPM has been added (e.g. <a href="https://github.com/stefanberger/swtpm">swtpm</a>)</li>
<li>Boot disk: Ensure SATA is set as the driver first. You can switch to VirtIO later after the drivers have been installed for performance.</li>
<li>Install Tailscale, Sunshine, VirtIO drivers</li>
</ul>
<p>Some additional performance tweaks:</p>
<ul>
<li>Enable <a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Example_with_systemd">CPU isolation</a> via systemd (avoid assiging CPU 0 to the VM, as it handles other kernel interrupts)</li>
<li>Enable <a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#CPU_pinning">CPU pinning</a> (make sure to pin CPUs sharing the same L1/L2/L3 caches togther - check with <code>lscpu -e</code>)</li>
<li>Ensure that NTFS on the guest uses the same <code>volblocksize</code> (usually 16K) as the host zvol.</li>
</ul>
<p>After the OS has been installed, reboot the VM and passthrough your GPUs (including the audio device) in <code>Add Hardware &gt; PCI Host Device</code>.</p>
<p>Install the GPU drivers as necessary.</p>
<details class="note">
<summary>(optional) Giving the VM an IP address on the LAN</summary>
<p>If you would like your VM also have its own IP address on the LAN (e.g. to play multiplayer games with peers on the same subnet), you can add a <a href="https://virt.kernelnewbies.org/MacVTap"><code>macvtap</code></a> interface now, in addition to the standard bridge network between guest and host.</p>
<p>To do this, add another <code>NIC</code> and ensure <code>Host device enpXsX: macvtap</code> is selected.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../../static/images/2022-07-10/vm-network.jpg" data-desc-position="bottom"><img alt="" src="../../../../../static/images/2022-07-10/vm-network.jpg"></a></p>
<p>If you just want to be able to access the VM over the internet, you can use a peer-to-peer VPN as shown <a href="#5-setup-overlay-mesh-network-aka-peer-to-peer-vpn">below</a>.</p>
</details>
<p>The GPU should now be visible in the guest.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../../static/images/2022-07-10/vm-gpu.jpg" data-desc-position="bottom"><img alt="" src="../../../../../static/images/2022-07-10/vm-gpu.jpg"></a></p>
<h2 id="3-optional-share-a-filesystem-between-host-and-guest">3. (Optional) Share a Filesystem between host and guest</h2>
<p>There are several options, with <a href="https://virtio-fs.gitlab.io/">VirtioFS</a> being the fastest, followed by <a href="https://www.samba.org/">SAMBA</a>, then Network File System (NFS).</p>
<p><strong>Note</strong>: If you are using only a <code>macvtap</code> interface, it is <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_host_configuration_and_guest_installation_guide/app_macvtap">not possible</a> to connect to the host due to how <code>macvtap</code> works. You will need to create a bridge (e.g. <code>Virtual Network 'Default' : NAT</code>) to connect to the host.</p>
<details class="note">
<summary>VirtioFS</summary>
<p>This is the fastest option for sharing a folder on the host to the guest if they are on the same device.</p>
<p>Follow the <a href="https://virtio-fs.gitlab.io/howto-windows.html">instructions</a> to set it up.</p>
</details>
<details class="note">
<summary>SAMBA</summary>
<p><a href="https://www.samba.org/">SAMBA</a> is much faster than NFS for Windows guests. It is also suitable for sharing folders on different devices across a network.</p>
<p>For NixOS, you can reference the following configuration:</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Samba</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>networking<span class="o">.</span>firewall<span class="o">.</span><span class="ss">allowPing</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>services<span class="o">.</span><span class="ss">samba-wsdd</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>  <span class="c1"># make shares visible for windows 10 clients</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>  <span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>  <span class="ss">openFirewall</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="p">};</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>services<span class="o">.</span><span class="ss">samba</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>  <span class="ss">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>  <span class="ss">openFirewall</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>  <span class="ss">settings</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="ss">software</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>      <span class="ss">path</span> <span class="o">=</span> <span class="s2">"/home/user/software"</span><span class="p">;</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>      <span class="ss">browseable</span> <span class="o">=</span> <span class="s2">"yes"</span><span class="p">;</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>      <span class="s2">"read only"</span> <span class="o">=</span> <span class="s2">"no"</span><span class="p">;</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>      <span class="s2">"guest ok"</span> <span class="o">=</span> <span class="s2">"yes"</span><span class="p">;</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>      <span class="s2">"acl allow execute always"</span> <span class="o">=</span> <span class="s2">"yes"</span><span class="p">;</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>      <span class="s2">"force user"</span> <span class="o">=</span> <span class="s2">"user"</span><span class="p">;</span> <span class="c1"># This is the most important line</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    <span class="p">};</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="ss">global</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>      <span class="ss">workgroup</span> <span class="o">=</span> <span class="s2">"WORKGROUP"</span><span class="p">;</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>      <span class="s2">"server string"</span> <span class="o">=</span> <span class="s2">"family-server"</span><span class="p">;</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>      <span class="s2">"netbios name"</span> <span class="o">=</span> <span class="s2">"family-server"</span><span class="p">;</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>      <span class="ss">security</span> <span class="o">=</span> <span class="s2">"user"</span><span class="p">;</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>      <span class="s2">"map to guest"</span> <span class="o">=</span> <span class="s2">"bad user"</span><span class="p">;</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="p">};</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>  <span class="p">};</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="p">};</span>
</span></code></pre></div>
<p>For Fedora:</p>
<ol>
<li>
<p>Install Samba on Linux:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>samba<span class="w"> </span>samba-common
</span></code></pre></div>
</li>
<li>
<p>Set the correct SELinux contexts/<a href="https://linux.die.net/man/8/samba_selinux">booleans</a> for the directories you wish to share (in this example <code>/mnt/storage</code>):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Allow samba to share any file/directory read/write:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>sudo<span class="w"> </span>setsebool<span class="w"> </span>-P<span class="w"> </span>samba_export_all_rw<span class="w"> </span><span class="m">1</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="c1"># Alternatively, if you want to restrict permissions to a directory:</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>sudo<span class="w"> </span>chcon<span class="w"> </span>-R<span class="w"> </span>-t<span class="w"> </span>samba_share_t<span class="w"> </span>/mnt/storage
</span></code></pre></div>
<details class="warning">
<summary>SSH and SELinux</summary>
<p>If you are executing the <code>chcon</code> command above on your <code>home</code> directory, be careful to restore SELinux contexts for the <code>.ssh</code> directory:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>sudo<span class="w"> </span>restorecon<span class="w"> </span>-r<span class="w"> </span>.ssh
</span></code></pre></div>
<p>Otherwise, <code>sshd</code> will be <strong>denied access</strong> to <code>authorized_keys</code> and you will lose login via SSH!</p>
</details>
</li>
<li>
<p>Add the following to <code>/etc/samba/smb.conf</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>[storage]
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    path = /mnt/storage
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    public = yes
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    guest ok = yes
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    writable = yes
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    browseable = yes
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    acl allow execute always = yes
</span></code></pre></div>
<p>This will create a share named <code>storage</code>, accessible without login or passwords. <strong>Only do this on a secure LAN!</strong></p>
</li>
<li>
<p>(For Fedora) Open the required ports in the <code>libvirt</code> zone (for the Windows guest), and in the <code>Public</code> zone for other computers on the network:</p>
<ul>
<li>TCP <code>139</code>, <code>445</code></li>
<li>UDP <code>137</code>, <code>138</code></li>
</ul>
</li>
<li>
<p>Restart the <code>smb</code> and <code>nmb</code> daemons:</p>
</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>smb<span class="w"> </span>nmb
</span></code></pre></div>
</details>
<details class="note">
<summary>NFS (not recommended)</summary>
<p>For sharing files with Windows clients, SAMBA is the better option (much less delay on opening compared to NFS).</p>
<p>Windows does not come with NFS support by default - you must enable it. In an elevated PowerShell window, run:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nb">Enable-WindowsOptionalFeature</span> <span class="n">-FeatureName</span> <span class="n">ServicesForNFS-ClientOnly</span><span class="p">,</span> <span class="n">ClientForNFS-Infrastructure</span> <span class="n">-Online</span> <span class="n">-NoRestart</span>
</span></code></pre></div>
<p>This <a href="https://docs.oracle.com/en-us/iaas/Content/File/Troubleshooting/winNFSerror53.htm">fix</a> <em>may</em> speed up NFS access on Windows (although I strongly recommend using SAMBA).</p>
<p><em>Note for Fedora: You must also open the NFS ports (TCP/UDP <code>111</code>, <code>2049</code> and <code>20048</code>) in the <code>Libvirt</code> zone.</em></p>
</details>
<p>And that's it! You now have a fully featured cloud gaming machine, accessible anywhere in the world.</p>
<h2 id="known-issuesnotesfixes">Known Issues/Notes/Fixes</h2>
<h3 id="slow-fps-on-desktop">Slow FPS on Desktop</h3>
<p><a href="https://moonlight-stream.org/">Moonlight</a> runs at 30fps or less when displaying the remote desktop (when not in a game). I suspect this is probably because the desktop is not rendered using the GPU and natively running at a lower FPS. Moonlight is transferring this output when the GPU is not being utilized, for example with the desktop or certain 2D games.</p>
<p>To fix this, download and install the <a href="https://github.com/VirtualDrivers/Virtual-Display-Driver">Windows Virtual Display Driver</a>. This sets up a dummy monitor which will be rendered by the GPU.</p>
<p>To remove the 'extra' desktop (added by libvirt), set the Video Device to None in Virtual Macihne Manager.</p>
<p><em>Note that without the video device, Virtual Machine Manager will not show any video, however the VM can still be accessed over Moonlight.</em></p>
<h3 id="amd-gpu-resetreboot-issue">AMD GPU Reset/Reboot Issue</h3>
<p>There is a <a href="https://forum.level1techs.com/t/the-state-of-amd-rx-7000-series-vfio-passthrough-april-2024/210242">known issue</a> with AMD GPUs locking up the host when the guest VM is rebooted.</p>
<p>Some <a href="https://forum.level1techs.com/t/vfio-pass-through-working-on-9070xt/227194">workarounds</a> have been discussed, however in my case, the solution that works is to unsure that the <strong>guest is never rebooted</strong>. Instead, allow the guest to shut down, and then start it again manually.</p>
<p>I think this works because once the guest is shut down, the <code>amdgpu</code> driver binds back to the VM, and this somefixes fixes the state of the card.</p>
<p>You can enforce that the guest never reboots by adding the following to the libvirt domain XML:</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nt">&lt;on_reboot&gt;</span>destroy<span class="nt">&lt;/on_reboot&gt;</span>
</span></code></pre></div>
<h3 id="disabling-vfio">Disabling VFIO</h3>
<p>At times you may want to disable VFIO or GPU passthrough, for example when you want to <a href="../docker-containers-with-gpu-access-in-fedora/">use the GPU in the host</a>.</p>
<p>To disable GPU passthrough, simply remove <code>vfio-pci.ids=xxxx:xxxx,yyyy:yyyy</code> from your <a href="https://wiki.archlinux.org/title/Kernel_parameters">kernel parameters</a> (or <code>boot.kernelParams</code> in NixOS) then reboot.</p>
<p><em>Note: For AMD GPUs, this might not be necessary, as the <code>amdgpu</code> driver automatically rebinds itself once the VM is shutdown.</em></p>
<h3 id="moonlight-specific-issues">Moonlight-specific Issues</h3>
<ul>
<li>
<p>Moonlight requires that the server machine (whether VM or physical) be <strong>unlocked</strong>, and that there are <strong>no Remote Desktop Connections</strong> ongoing.</p>
<ul>
<li>
<p>After an RDP session, the main desktop is locked. To fix this, create a batch file with the following content, and run it <strong>with administrator rights</strong> to disconnect the RDP and unlock the main desktop:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>Powershell -Command "tscon rdp-tcp#0 /DEST:console"
</span></code></pre></div>
</li>
</ul>
</li>
<li>
<p>The streaming resolution of Moonlight is <strong>not</strong> what is set in the GUI of Moonlight or in the game, but rather, it is capped at the resolution of the virtual machine's desktop. So, if you want to stream in 4K, ensure you change the virtual machine's desktop resolution to 4K prior to launching the game.</p>
</li>
<li>
<p>Some useful shortcuts:</p>
<ul>
<li>Quit moonlight: <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-alt">Alt</kbd><span>+</span><kbd class="key-shift">Shift</kbd><span>+</span><kbd class="key-q">Q</kbd></span></li>
<li>Minimize window: <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-alt">Alt</kbd><span>+</span><kbd class="key-shift">Shift</kbd><span>+</span><kbd class="key-d">D</kbd></span></li>
<li>Show stats overlay: <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-alt">Alt</kbd><span>+</span><kbd class="key-shift">Shift</kbd><span>+</span><kbd class="key-s">S</kbd></span></li>
<li>Paste text from host: <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-alt">Alt</kbd><span>+</span><kbd class="key-shift">Shift</kbd><span>+</span><kbd class="key-v">V</kbd></span></li>
<li>Toggle mouse and keyboard capture: <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-alt">Alt</kbd><span>+</span><kbd class="key-shift">Shift</kbd><span>+</span><kbd class="key-z">Z</kbd></span></li>
</ul>
</li>
<li>
<p>Moonlight not filling screen:</p>
<ul>
<li><a href="https://github.com/moonlight-stream/moonlight-android/issues/588">Use the Nvidia control panel to change the screen resolution.</a></li>
</ul>
</li>
<li>
<p>Intermittent black screen: <a href="https://github.com/moonlight-stream/nvidia-gamestream-issues/issues/27">Disable hardware-accelerated GPU scheduling</a></p>
</li>
</ul>
<h3 id="qemuvirt-manager">QEMU/<code>virt-manager</code></h3>
<ul>
<li>
<p>Snapshotting the VM is not possible while a PCI device is being passed-through. However, if you are using BtrFS, you can make snapshots of the storage volume.</p>
</li>
<li>
<p>VM hangs/pauses, and in <code>dmesg</code> you see <code>[ 6044.433981] vfio-pci 0000:07:00.0: BAR 0: can't reserve [mem 0xe0000000-0xefffffff 64bit pref]</code> and similar errors:</p>
<ul>
<li>Ensure that the <a href="https://forum.proxmox.com/threads/problem-with-gpu-passthrough.55918/post-478351"><code>initcall_blacklist=sysfb_init</code></a> kernel parameter has been added to <code>grub.cfg</code>.</li>
</ul>
</li>
<li>
<p><code>virt-manager</code>/QEMU supports sharing the VM display via an embedded VNC server. For Apache Guacamole to connect to this however, the embedded viewer (in <code>virt-manager</code>) must first be closed.</p>
</li>
<li>
<p>Windows XP only: In <code>virt-manager</code>, the NIC device model must be <code>rtl8139</code>, and the sound card model as <code>AC97</code> in order for drivers to be installed.</p>
</li>
<li>
<p>Nvidia Geforce Experience says 'Unsupported CPU':</p>
<ul>
<li>Change the CPU model in <code>virt-manager</code> (in the XML) to <code>host-model</code> (<a href="https://libvirt.org/formatdomain.html#cpu-model-and-topology">preferred</a>) or <code>host-passthrough</code>.</li>
</ul>
</li>
<li>
<p>Passthrough-ed USB devices, when disconnected, prevent the VM from booting</p>
<ul>
<li>Add <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/sect-manipulating_the_domain_xml-devices#sect-Host_physical_machine_device_assignment-USB_PCI_devices"><code>startupPolicy="optional"</code></a> to the <code>&lt;source&gt;</code> tag in the XML for the passthrough-ed USB device</li>
</ul>
</li>
<li>
<p>Low FPS when display is set to 'Duplicate these displays':</p>
<ul>
<li>Change display settings to 'Extend these displays' instead. I suspect when displays are duplicated, the GPU works extra to render frames on both monitors, causing the FPS drop.</li>
</ul>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index">Useful VM performance tuning options</a></p>
<ul>
<li>For example, setting multiple sockets with each having 1 CPU and 1 core is more efficient.</li>
</ul>
</li>
<li>
<p>Types of VM network connections compared:
  <a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../../static/images/2022-07-10/vm-networking.png" data-desc-position="bottom"><img alt="" src="../../../../../static/images/2022-07-10/vm-networking.png"></a></p>
</li>
</ul>
<p>For more information on the <code>libvirt</code> domain XML, check out the <a href="https://libvirt.org/formatdomain.html">documentation</a>.</p>
<h3 id="apache-guacamole">Apache Guacamole</h3>
<ul>
<li>For RDP, 'Support audio in console' must be <strong>unchecked</strong> for sound to work.</li>
</ul>
<h3 id="tailscale-latency-issues">Tailscale latency issues</h3>
<p>At times, Tailscale may not be able to achieve a direct connection (e.g. due to a <a href="https://tailscale.com/blog/how-nat-traversal-works/">hard NAT</a>), and will fallback to using a relay. This can be seen with <code>tailscale status</code>. This is sometimes annoying, and made complicated by the fact that when running the VM behind the same NAT as the host (e.g. behind the same network), you can only forward port <code>41641</code> (used for the Wireguard connection) to one device (either the host, or the VM's <code>macvtap</code> adapter). I've tried <a href="https://github.com/tailscale/tailscale/issues/5114#issuecomment-1402806749">changing the listen port</a> to <code>41640</code> for the VM, and despite being able to achieve connectivity via <code>nc</code>, Tailscale still intermittently refuses to use that port.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:default-network">
<p>The default network (which you can view with <code>sudo virsh net-dumpxml default</code>) is configured with <a href="https://libvirt.org/formatnetwork.html#connectivity"><code>forward mode='nat'</code></a>, which allows outbound communication for guests, but not inbound communications (unless you configure computers on the LAN to use your host as a NAT).&nbsp;<a class="footnote-backref" href="#fnref:default-network" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>







  
  




  




<h2 id="__comments">Comments</h2>
<script src="https://giscus.app/client.js" data-repo="extrange/personal-blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzNzE1Mzc1Mjc=" data-category="Announcements" data-category-id="DIC_kwDOFiU2d84CRQpc" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="dark" data-lang="en" crossorigin="anonymous" async></script>

<!-- Synchronize Giscus theme with palette -->
<script>
  var giscus = document.querySelector("script[src*=giscus]");

  /* Set palette on initial load */
  var palette = __md_get("__palette");
  if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light";
    giscus.setAttribute("data-theme", theme);
  }

  /* Register event handlers after documented loaded */
  document.addEventListener("DOMContentLoaded", function () {
    var ref = document.querySelector("[data-md-component=palette]");
    ref.addEventListener("change", function () {
      var palette = __md_get("__palette");
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light";

        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame");
        frame.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          "https://giscus.app"
        );
      }
    });
  });
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/extrange/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path></svg>
    </a>
  
    
    
    
    
    <a href="mailto:me@nicholaslyz.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["navigation.instant", "header.autohide", "navigation.sections", "navigation.indexes", "navigation.expand", "content.code.copy"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html><!-- Giscus -->