
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://nicholaslyz.com/blog/2025/06/07/btrfs-vs-zfs-performance/">
      
      
        <link rel="prev" href="../../../05/14/dm-crypt-causing-system-freezes/">
      
      
        <link rel="next" href="../../10/migrating-to-systemd-boot-on-fedora/">
      
      
      <link rel="icon" href="../../../../../static/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Btrfs vs ZFS Performance - Nicholas</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/code.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/bookerly/font.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Btrfs vs ZFS Performance - Nicholas" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://nicholaslyz.com/assets/images/social/blog/posts/2025-06-07-btrfs-zfs-performance.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://nicholaslyz.com/blog/2025/06/07/btrfs-vs-zfs-performance/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Btrfs vs ZFS Performance - Nicholas" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://nicholaslyz.com/assets/images/social/blog/posts/2025-06-07-btrfs-zfs-performance.png" >
      
    
    
   <link href="../../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="yellow">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#btrfs-vs-zfs-performance" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Nicholas" class="md-header__button md-logo" aria-label="Nicholas" data-md-component="logo">
      
  <img src="../../../../../static/images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nicholas
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Btrfs vs ZFS Performance
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Nicholas" class="md-nav__button md-logo" aria-label="Nicholas" data-md-component="logo">
      
  <img src="../../../../../static/images/favicon.png" alt="logo">

    </a>
    Nicholas
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/books/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Books
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/cooking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cooking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/debates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/finance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Finance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/insurance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Insurance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/outdoor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Outdoor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Philosophy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/programming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Programming
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Pinned
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Pinned
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../dead-mans-switch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dead Man's Switch
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Lifestyle
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Lifestyle
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../principles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Principles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../daily-routine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Daily Routine
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../mountaineering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mountaineering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../photography/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Photography
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../piano/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Piano
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../travel-bucket-list/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Travel Bucket List
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#test-results" class="md-nav__link">
    <span class="md-ellipsis">
      Test Results
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#raw-disk-vs-cow-filesystems" class="md-nav__link">
    <span class="md-ellipsis">
      Raw disk vs CoW filesystems
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#btrfs-datacow-vs-nodatacow" class="md-nav__link">
    <span class="md-ellipsis">
      Btrfs datacow vs nodatacow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-place-writes" class="md-nav__link">
    <span class="md-ellipsis">
      In-place writes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshot-performance" class="md-nav__link">
    <span class="md-ellipsis">
      Snapshot Performance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#btrfs-autodefrag" class="md-nav__link">
    <span class="md-ellipsis">
      Btrfs autodefrag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zfs-datasets-vs-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      ZFS datasets vs volumes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raid1raidz" class="md-nav__link">
    <span class="md-ellipsis">
      RAID1/RAIDZ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2025-06-07 00:00:00+00:00" class="md-ellipsis">June 7, 2025</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/programming/">Programming</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              5 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




<h1 id="btrfs-vs-zfs-performance">Btrfs vs ZFS Performance</h1>
<p>I have been using Btrfs for my server for a few years, but recently ran into performance issues with databases and snapshots. On the internet, ZFS seemed a pretty popular alternative, so I decided to compare the two in various aspects.</p>
<!-- more -->

<p>Both ZFS and Btrfs are <a href="https://wiki.archlinux.org/title/Btrfs#Copy-on-Write_(CoW)">copy-on-write</a> (CoW) filesystems. These types of filesystems do not overwrite data in-place. Instead, they write file data to a new block, then update file metadata to point to it. As a result, their performance characteristics differ quite a bit from a traditional non-CoW filesystem like XFS or ext4.</p>
<p>For this article, I am using <a href="https://github.com/extrange/fio-benchmarks/">test scripts</a> I have written which use <a href="https://github.com/axboe/fio">fio</a>, a highly customizable I/O testing tool supporting a variety of testing patterns.</p>
<p>The test setup for this article is a spare hard drive I have:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>❯<span class="w"> </span>sudo<span class="w"> </span>parted<span class="w"> </span>/dev/sda<span class="w"> </span>print
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>Model:<span class="w"> </span>ATA<span class="w"> </span>TOSHIBA<span class="w"> </span>DT01ACA1<span class="w"> </span><span class="o">(</span>scsi<span class="o">)</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>Disk<span class="w"> </span>/dev/sda:<span class="w"> </span>1000GB
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>Sector<span class="w"> </span>size<span class="w"> </span><span class="o">(</span>logical/physical<span class="o">)</span>:<span class="w"> </span>512B/4096B
</span></code></pre></div>
<p>All tests are done without caches/buffers (<code>direct=1</code> in fio).</p>
<p>ZFS supports some tunable parameters, some of which are:</p>
<ul>
<li><a href="https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html#dataset-recordsize">recordsize</a>: This is the minimum size which must be read from either disk/cache when data in a file is to be modified. Writes which are smaller than this will require that the whole record be read and rewritten. Only applicable for datasets.</li>
<li><a href="https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html#zvol-volblocksize">volblocksize</a>: The analogous property to recordsize, only applicable for volumes.</li>
<li><a href="https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html#alignment-shift-ashift">ashift</a>: The block alignment size that ZFS will use per vdev, or equivalently, the smallest possible IO on a vdev.</li>
<li><a href="https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html#adaptive-replacement-cache">primarycache</a>: The Adaptive Replacement Cache, an improvement over LRU caches.</li>
</ul>
<h2 id="test-results">Test Results</h2>
<h3 id="raw-disk-vs-cow-filesystems">Raw disk vs CoW filesystems</h3>
<p>First, let's compare the performance of the raw disk versus these filesystems on top.</p>
<ul>
<li>Btrfs mount options: <code>datacow,noatime,defaults</code></li>
<li>ZFS dataset parameters: <code>atime=off, ashift=0, primarycache=metadata, compression=off</code></li>
</ul>
<p>Sequential:</p>
<table>
<thead>
<tr>
<th>Test (in MB/s)</th>
<th style="text-align: right;">Raw</th>
<th style="text-align: right;">Btrfs</th>
<th style="text-align: right;">ZFS 128k</th>
<th style="text-align: right;">ZFS 4k</th>
</tr>
</thead>
<tbody>
<tr>
<td>SEQ1M_Q8T1 Read</td>
<td style="text-align: right;">164</td>
<td style="text-align: right;">185</td>
<td style="text-align: right;">126</td>
<td style="text-align: right;">55</td>
</tr>
<tr>
<td>SEQ1M_Q8T1 Write</td>
<td style="text-align: right;">188</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">162</td>
<td style="text-align: right;">63</td>
</tr>
<tr>
<td>SEQ1M_Q1T1 Read</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">153</td>
<td style="text-align: right;">69</td>
</tr>
<tr>
<td>SEQ1M_Q1T1 Write</td>
<td style="text-align: right;">188</td>
<td style="text-align: right;">184</td>
<td style="text-align: right;">143</td>
<td style="text-align: right;">64</td>
</tr>
</tbody>
</table>
<p>Btrfs is the fastest here, while ZFS is the slowest. This might be due to read-ahead or other optimizations that Btrfs is doing that I'm not aware of.</p>
<p>Random:</p>
<table>
<thead>
<tr>
<th>Test (in IOPS)</th>
<th style="text-align: right;">Raw</th>
<th style="text-align: right;">Btrfs</th>
<th style="text-align: right;">ZFS 128k</th>
<th style="text-align: right;">ZFS 4k</th>
</tr>
</thead>
<tbody>
<tr>
<td>RND4K_Q32T1 Read</td>
<td style="text-align: right;">220</td>
<td style="text-align: right;">226</td>
<td style="text-align: right;">118</td>
<td style="text-align: right;">119</td>
</tr>
<tr>
<td>RND4K_Q32T1 Write</td>
<td style="text-align: right;">396</td>
<td style="text-align: right;">16977</td>
<td style="text-align: right;">116</td>
<td style="text-align: right;">8787</td>
</tr>
<tr>
<td>RND4K_Q1T1 Read</td>
<td style="text-align: right;">140</td>
<td style="text-align: right;">147</td>
<td style="text-align: right;">109</td>
<td style="text-align: right;">121</td>
</tr>
<tr>
<td>RND4K_Q1T1 Write</td>
<td style="text-align: right;">410</td>
<td style="text-align: right;">6139</td>
<td style="text-align: right;">112</td>
<td style="text-align: right;">8262</td>
</tr>
</tbody>
</table>
<p>Btrfs wins again, with ZFS at 4k recordsize second.</p>
<p>On CoW filesystems, random writes with high queue depths can exceed that of the raw disk, since the writes can happen sequentially on disk. The filesystem maps them to the correct offsets in the file.</p>
<h3 id="btrfs-datacow-vs-nodatacow">Btrfs <code>datacow</code> vs <code>nodatacow</code></h3>
<p>We can directly evaluate the performance characteristics of Btrfs when CoW is turned off (<a href="https://btrfs.readthedocs.io/en/latest/Administration.html">btrfs-admin</a>), and writes are done in-place.</p>
<table>
<thead>
<tr>
<th>Test (MB/s)</th>
<th style="text-align: right;"><code>datacow</code></th>
<th style="text-align: right;"><code>nodatacow</code></th>
<th style="text-align: right;">Raw</th>
</tr>
</thead>
<tbody>
<tr>
<td>SEQ1M_Q8T1 Read</td>
<td style="text-align: right;">185</td>
<td style="text-align: right;">195</td>
<td style="text-align: right;">164</td>
</tr>
<tr>
<td>SEQ1M_Q8T1 Write</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">187</td>
<td style="text-align: right;">188</td>
</tr>
<tr>
<td>SEQ1M_Q1T1 Read</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">195</td>
<td style="text-align: right;">190</td>
</tr>
<tr>
<td>SEQ1M_Q1T1 Write</td>
<td style="text-align: right;">184</td>
<td style="text-align: right;">195</td>
<td style="text-align: right;">188</td>
</tr>
</tbody>
</table>
<p>No measurable difference in sequential performance.</p>
<table>
<thead>
<tr>
<th>Test (IOPS)</th>
<th style="text-align: right;"><code>datacow</code></th>
<th style="text-align: right;"><code>nodatacow</code></th>
<th style="text-align: right;">Raw</th>
</tr>
</thead>
<tbody>
<tr>
<td>RND4K_Q32T1 Read</td>
<td style="text-align: right;">226</td>
<td style="text-align: right;">217</td>
<td style="text-align: right;">220</td>
</tr>
<tr>
<td>RND4K_Q32T1 Write</td>
<td style="text-align: right;">16977</td>
<td style="text-align: right;">402</td>
<td style="text-align: right;">396</td>
</tr>
<tr>
<td>RND4K_Q1T1 Read</td>
<td style="text-align: right;">147</td>
<td style="text-align: right;">155</td>
<td style="text-align: right;">140</td>
</tr>
<tr>
<td>RND4K_Q1T1 Write</td>
<td style="text-align: right;">6139</td>
<td style="text-align: right;">350</td>
<td style="text-align: right;">410</td>
</tr>
</tbody>
</table>
<p><code>nodatacow</code> random write speeds drop back to that of the raw disk.</p>
<p>As COW is turned off, random writes happen in-place on disk, and so suffer the same penalties as the raw disk.</p>
<div class="admonition warning">
<p class="admonition-title">nodatacow and checksums</p>
<p>When <code>nodatacow</code> is turned on, checksums (and compression) are disabled. Data corruption cannot be detected. In a RAID1 setup, it will not be possible to determine which disk has the correct block and correction is thus not possible.</p>
<p>For this reason, despite the performance benefit, <code>nodatacow</code> should not be used.</p>
<ul>
<li>Reddit: <a href="https://old.reddit.com/r/btrfs/comments/xki69r/nodatacow_and_data_loss/">NoDataCow and data loss</a></li>
<li>Unraid: <a href="https://forums.unraid.net/topic/123037-reconsider-btrfs-nocow-default-option-on-domains-share-due-to-irrecoverable-corruption-risks/">Reconsider Btrfs NOCOW Default Option on domains Share due to Irrecoverable Corruption Risks</a></li>
</ul>
</div>
<h3 id="in-place-writes">In-place writes</h3>
<p>A common database workload involves reading/writing repeatedly to the same file at random locations. This causes fragmentation of the file in CoW filesystems, since the writes are not done in-place. Subsequent sequential reading of the file is going to be slower, possibly close to that of random read performance.</p>
<p>We can simulate this by first writing a large file, doing random writes for a while, and then reading the same file sequentially.</p>
<ul>
<li><em>ZFS dataset parameters: <code>atime=off, ashift=0, primarycache=metadata, compression=off</code></em></li>
<li><em><code>datacow</code> and <code>nodatacow</code> refer to Btrfs with the respective mount option</em></li>
</ul>
<table>
<thead>
<tr>
<th>Test</th>
<th style="text-align: right;"><code>datacow</code></th>
<th style="text-align: right;">ZFS 128k</th>
<th style="text-align: right;">ZFS 4k</th>
<th style="text-align: right;"><code>nodatacow</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>SEQ1M_Q8T1 Write, MB/s</td>
<td style="text-align: right;">188</td>
<td style="text-align: right;">182</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">187</td>
</tr>
<tr>
<td>SEQ1M_Q8T1 Read, IOPS (Pre)</td>
<td style="text-align: right;">187</td>
<td style="text-align: right;">183</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">192</td>
</tr>
<tr>
<td>RND4K_Q32T1 Write, IOPS</td>
<td style="text-align: right;">20024</td>
<td style="text-align: right;">92</td>
<td style="text-align: right;">4933</td>
<td style="text-align: right;">271</td>
</tr>
<tr>
<td>SEQ1M_Q8T1 Read, MB/s (Post)</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">188</td>
</tr>
</tbody>
</table>
<p>Here, we see that the performance of Btrfs with CoW is abyssmal.</p>
<p>At a recordsize of 128k, ZFS does much better, coming in at around half the perfomance if one were to write in-place (simulated via <code>nodatacow</code>). However at 4k recordsize, the performance drops significantly.</p>
<p>In fragmented files/workloads causing fragmentation, a large recordsize can help with sequential reads, at the price of slower random writes (<a href="https://old.reddit.com/r/zfs/comments/shnms0/plex_performance_sqlite_page_size_4k_align_to_zfs/hv4d0yp/">IO amplification due to read-modify-write cycles</a>).</p>
<p><em>Note: Btrfs does not offer any way to set the default extent size (the equivalent of recordsize). At present the minimum size is 4kB, with no limit on the maximum.</em></p>
<h3 id="snapshot-performance">Snapshot Performance</h3>
<p>Taking repeated snapshots of a filesystem can affect performance, since defragmentation of any sort can't really happen while snapshotted blocks are still being referenced.</p>
<p>In this test, we take repeated snapshots (~3/s) while the random writes are being done, which should theoretically hamper optimization attempts to sequentially align data.</p>
<ul>
<li>ZFS dataset parameters: <code>atime=off, ashift=0, primarycache=metadata, compression=off</code></li>
</ul>
<table>
<thead>
<tr>
<th>Test</th>
<th style="text-align: right;">128k</th>
<th style="text-align: right;">128k, snaps</th>
<th style="text-align: right;">4k</th>
<th style="text-align: right;">4k, snaps</th>
</tr>
</thead>
<tbody>
<tr>
<td>SEQ1M_Q8T1 Write, MB/s</td>
<td style="text-align: right;">182</td>
<td style="text-align: right;">180</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">73</td>
</tr>
<tr>
<td>SEQ1M_Q8T1 Read, MB/s (Post)</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>
<h3 id="btrfs-autodefrag">Btrfs <code>autodefrag</code></h3>
<p>Btrfs` <a href="https://btrfs.readthedocs.io/en/latest/Administration.html">autodefrag</a> feature reads <em>"When enabled, small random writes into files (in a range of tens of kilobytes, currently it’s 64KiB) are detected and queued up for the defragmentation process."</em></p>
<p>Let's see how turning this on changes things:</p>
<ul>
<li>Btrfs mount options: <code>datacow,noatime,defaults</code></li>
</ul>
<table>
<thead>
<tr>
<th>Test</th>
<th style="text-align: right;">noautodefrag</th>
<th style="text-align: right;">autodefrag</th>
</tr>
</thead>
<tbody>
<tr>
<td>SEQ1M_Q8T1 Write</td>
<td style="text-align: right;">188 MB/s</td>
<td style="text-align: right;">186 MB/s</td>
</tr>
<tr>
<td>SEQ1M_Q8T1 Read (Pre)</td>
<td style="text-align: right;">187 MB/s</td>
<td style="text-align: right;">187 MB/s</td>
</tr>
<tr>
<td>RND4K_Q32T1 Write</td>
<td style="text-align: right;">20024 IOPS</td>
<td style="text-align: right;">19708 IOPS</td>
</tr>
<tr>
<td>SEQ1M_Q8T1 Read (Post)</td>
<td style="text-align: right;">1 MB/s</td>
<td style="text-align: right;">1 MB/s</td>
</tr>
</tbody>
</table>
<p>No measurable difference.</p>
<h3 id="zfs-datasets-vs-volumes">ZFS datasets vs volumes</h3>
<p>ZFS also supports volumes (zvols), which are datasets that represent a block device. These can be passed as a raw disk to a VM, while still retaining checksums and the ability to snapshot the volume.</p>
<ul>
<li><em>ZFS dataset parameters: <code>atime=off, ashift=0, primarycache=metadata, compression=off</code></em></li>
<li><em>ZFS zvol parameters: <code>ashift=12, compression=off</code></em></li>
<li><em>Despite turning off caches, results for the SEQ1M_Q8T1 read for zvols were unrealistically high and so they are omitted.</em></li>
</ul>
<table>
<thead>
<tr>
<th>Test (MB/s)</th>
<th style="text-align: right;">Dataset, 16k</th>
<th style="text-align: right;">zvol, 16k</th>
</tr>
</thead>
<tbody>
<tr>
<td>SEQ1M_Q8T1 Write</td>
<td style="text-align: right;">158</td>
<td style="text-align: right;">113</td>
</tr>
<tr>
<td>SEQ1M_Q1T1 Read</td>
<td style="text-align: right;">156</td>
<td style="text-align: right;">264</td>
</tr>
<tr>
<td>SEQ1M_Q1T1 Write</td>
<td style="text-align: right;">151</td>
<td style="text-align: right;">43</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Test (IOPS)</th>
<th style="text-align: right;">Dataset, 16k</th>
<th style="text-align: right;">zvol, 16k</th>
</tr>
</thead>
<tbody>
<tr>
<td>RND4K_Q32T1 Read</td>
<td style="text-align: right;">127</td>
<td style="text-align: right;">458</td>
</tr>
<tr>
<td>RND4K_Q32T1 Write</td>
<td style="text-align: right;">121</td>
<td style="text-align: right;">176</td>
</tr>
<tr>
<td>RND4K_Q1T1 Read</td>
<td style="text-align: right;">112</td>
<td style="text-align: right;">210</td>
</tr>
<tr>
<td>RND4K_Q1T1 Write</td>
<td style="text-align: right;">124</td>
<td style="text-align: right;">63</td>
</tr>
</tbody>
</table>
<h3 id="raid1raidz">RAID1/RAIDZ</h3>
<p>We would also like to see if there are any performance gains when using a RAID1 setup, because in theory, reads can be fulfilled by both devices simultaneously.</p>
<p>To do this, we can run benchmarks on both Btrfs and ZFS, with and without RAID1 setup.</p>
<p><em>In progress</em></p>
<p>Of note when using RAIDZ, to improve random IOPS, <a href="https://web.archive.org/web/20150203051453/https://blog.delphix.com/matt/2014/06/06/zfs-stripe-width/">use less disks per vdev</a> (or better, a mirror).</p>
<h2 id="conclusion">Conclusion</h2>
<p>CoW filesystems allow for efficient snapshotting, and come with a variety of useful features such as checksumming, compression and encryption (only for ZFS). The main drawbacks are due to the CoW mechanism, most clearly observed with heavy random write workloads which cause fragmentation. To some extent, this can be mitigated by increasing the extent/record size, sacrificing random write IOPS for sequential read speeds. At the time of this writing, only ZFS allows for that.</p>







  
  




  



<!-- Giscus -->
<h2 id="__comments">Comments</h2>
<script
  src="https://giscus.app/client.js"
  data-repo="extrange/personal-blog"
  data-repo-id="MDEwOlJlcG9zaXRvcnkzNzE1Mzc1Mjc="
  data-category="Announcements"
  data-category-id="DIC_kwDOFiU2d84CRQpc"
  data-mapping="pathname"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="dark"
  data-lang="en"
  crossorigin="anonymous"
  async
></script>

<!-- Synchronize Giscus theme with palette -->
<script>
  var giscus = document.querySelector("script[src*=giscus]");

  /* Set palette on initial load */
  var palette = __md_get("__palette");
  if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light";
    giscus.setAttribute("data-theme", theme);
  }

  /* Register event handlers after documented loaded */
  document.addEventListener("DOMContentLoaded", function () {
    var ref = document.querySelector("[data-md-component=palette]");
    ref.addEventListener("change", function () {
      var palette = __md_get("__palette");
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light";

        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame");
        frame.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          "https://giscus.app"
        );
      }
    });
  });
</script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/extrange/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:me@nicholaslyz.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "header.autohide", "navigation.sections", "navigation.indexes", "navigation.expand", "content.code.copy"], "search": "../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>